# 日本株短期上昇予測システム 仕様書

## 1. システム概要

東証プライム銘柄から「20営業日以内に+10%上昇が期待できる銘柄」を日次ランキングし、
買いのみの戦略で利益を出す機械学習システム。

### 現在の成績（v8）
- 勝率: 66.7%
- 総リターン: +57.70%
- PF: 2.13
- 取引回数: 18回（2024年1-6月）

---

## 2. 売買ルール

### エントリー
- 毎日引け後にスコア上位1銘柄を選定
- 翌営業日の寄付きで買い

### イグジット（トリプルバリア）
| 条件 | トリガー | 決済価格 |
|------|----------|----------|
| 利確 | 高値が entry_price × 1.10 に到達 | +10% |
| 損切 | 安値が entry_price × 0.90 に到達 | -10% |
| タイムアウト | 20営業日経過 | 終値 |

### シグナル条件
- スコア ≥ 0.55（スコア閾値）
- rank1 - rank2 スコア差 ≥ 0.02（確信度）

---

## 3. データ・ユニバース

### データソース
- yfinance（日足OHLCV）
- 期間: 2022-01-01〜現在

### ユニバースフィルタ

#### 流動性フィルタ
- 株価: 100円〜50,000円
- 売買代金: ≥ 1億円/日（20日平均）
- 出来高: ≥ 10万株/日（20日平均）

#### ファンダメンタルフィルタ
- ROE > 0%（赤字企業除外）
- 時価総額 > 100億円

---

## 4. ラベル定義

```
シグナル日: d日目（当日終値時点で予測）
エントリー: d+1日目の始値

判定（d+1 〜 d+20の間）:
  - 高値が entry_price × 1.10 に先に到達 → label=1
  - 安値が entry_price × 0.90 に先に到達 → label=0
  - どちらにも到達しない → label=0（タイムアウト）
  - 同日両方到達 → label=0（損切り優先、保守的）
```

---

## 5. 特徴量（47個 → Top 20選択）

### 特徴量選択の効果
47個全部使用すると過学習が発生。重要度Top 20に絞ることで大幅改善。

### 選択される特徴量（Top 20）
```
feat_atr_pct              ATR正規化（最重要）
feat_from_52w_low         52週安値からの距離
feat_from_52w_high        52週高値からの距離
feat_volatility_20d       20日ボラティリティ
feat_macd_signal          MACDシグナル
feat_bb_width             ボリンジャーバンド幅
feat_obv_change_20d       OBV変化率20日
feat_price_position_52w   52週価格位置
feat_volume_trend         出来高トレンド
feat_macd_hist            MACDヒストグラム
feat_sector_*             セクターダミー（数個）
feat_ret_20d              20日リターン
feat_high_20d_dist        20日高値距離
feat_obv_change_5d        OBV変化率5日
feat_rsi_14               RSI
feat_macd                 MACD
```

### 全特徴量カテゴリ（参考）
| グループ | 個数 | 内容 |
|----------|------|------|
| 価格系 | 8 | リターン、MA乖離、高安距離 |
| 出来高系 | 3 | 出来高異常度、売買代金 |
| ローソク足 | 6 | 実体比率、ヒゲ、ギャップ |
| RSI | 3 | RSI値、売られすぎ/買われすぎ |
| MACD | 4 | MACD、シグナル、ヒストグラム |
| ボリンジャー | 2 | BB位置、バンド幅 |
| ATR | 1 | ATR正規化 |
| 価格位置 | 3 | 52週高値/安値距離 |
| 需給代替 | 6 | OBV、出来高トレンド |
| セクター | 11 | セクターダミー変数 |

---

## 6. モデル

### LightGBM
```python
params = {
    'objective': 'binary',
    'metric': 'auc',
    'boosting_type': 'gbdt',
    'num_leaves': 31,
    'learning_rate': 0.05,
    'feature_fraction': 0.8,
    'bagging_fraction': 0.8,
    'bagging_freq': 5,
    'scale_pos_weight': auto,  # クラス不均衡対応
    'seed': 42
}
num_boost_round = 300
```

### ローリング学習
- 毎月再学習
- 学習データ: 直近6ヶ月
- 評価期間: 翌1ヶ月

---

## 7. 設定値（config.py）

```python
# ラベル設定
LABEL_TAKE_PROFIT = 0.10     # 利確: +10%
LABEL_STOP_LOSS = 0.10       # 損切り: -10%
LABEL_HORIZON_DAYS = 20      # 最大保持期間

# 予測設定
SCORE_THRESHOLD = 0.55       # スコア閾値
MIN_SCORE_GAP = 0.02         # 最小スコア差
TOP_N_STOCKS = 1             # 上位1銘柄のみ
TOP_N_FEATURES = 20          # 特徴量選択

# ファンダフィルタ
FUNDAMENTAL_FILTER = {
    'min_roe': 0.0,          # ROE > 0%
    'min_market_cap': 100e9, # 時価総額 > 100億円
}

# 学習設定
ROLLING_TRAIN_MONTHS = 6     # 学習期間
TEST_START = date(2024, 1, 1)
TEST_END = date(2024, 6, 30)
```

---

## 8. 実行方法

```bash
# 仮想環境を使用
.venv/bin/python scripts/phase1_data_check.py   # データ取得
.venv/bin/python scripts/phase2_train.py        # 学習
.venv/bin/python scripts/phase3_backtest.py     # バックテスト

# または一括
.venv/bin/python scripts/run_full_test.py
```

---

## 9. ファイル構成

```
stock-prediction/
├── CLAUDE.md                # Claudeコンテキスト（これを読む）
├── config.py                # 本番設定
├── app.py                   # Streamlit UI
├── scripts/
│   ├── phase1_data_check.py # データ取得
│   ├── phase2_train.py      # 学習
│   ├── phase3_backtest.py   # バックテスト
│   └── run_full_test.py     # フルテスト
├── src/
│   ├── backtest/engine.py   # バックテストエンジン
│   ├── data/
│   │   ├── loader.py        # yfinanceデータ取得
│   │   ├── universe.py      # 銘柄リスト
│   │   └── universe_filter.py # ファンダフィルタ
│   ├── features/builder.py  # 特徴量生成
│   └── model/
│       ├── labels.py        # ラベル生成
│       └── trainer.py       # LightGBM学習
├── data/                    # 生成データ
│   ├── labeled_data.parquet
│   ├── predictions.parquet
│   └── backtest_trades.csv
├── models/
│   └── predictor.pkl        # 学習済みモデル
└── docs/
    └── SPECIFICATION.md     # このファイル
```

---

## 10. 実験履歴

### バージョン別結果サマリー

| Ver | 取引 | 勝率 | 損切率 | 総損益 | 評価 | 主な変更 |
|-----|------|------|--------|--------|------|----------|
| v1 | - | 44% | 39% | - | 失敗 | 初期版 |
| v2 | 100 | 52% | 43% | +6.64% | 改善 | ラベル修正 |
| v3 | 22 | 59% | 27% | +41.35% | 良好 | ファンダフィルタ |
| v4 | 9 | 44% | 22% | +11.15% | 悪化 | フィルタ厳格化 |
| v5 | 14 | 36% | 57% | -31.82% | 失敗 | 複合変更 |
| v6 | 18 | 44% | 50% | -12.47% | 失敗 | 閾値緩和 |
| v7 | 30 | 50% | 47% | -3.67% | 失敗 | 同時保有2銘柄 |
| v8 | 18 | **67%** | 28% | **+57.70%** | **最良** | **特徴量選択** |

---

## 11. 重要な教訓

### やって良かったこと
1. ラベル定義を実トレードルールと一致させる
2. 緩やかなファンダメンタルフィルタ（ROE > 0, 時価総額 > 100億円）
3. 需給代替指標とセクターダミー変数の追加
4. ローリング学習（直近6ヶ月で毎月再学習）
5. **特徴量選択（Top 20）で過学習防止** ← 最重要

### やってはいけないこと
1. **ボラティリティに上限を設ける** → タイムアウト増加
2. **ボラティリティに下限を設ける** → 損切り増加
3. **スコア閾値を上げる（0.55→0.60）** → 精度向上せず
4. **スコア閾値を下げる（0.55→0.50）** → 質の悪いトレード増加
5. **フィルタを厳しくしすぎる** → サンプル不足
6. **複数の変更を同時に行う** → 原因特定困難
7. **特徴量を増やしすぎる（47個以上）** → 過学習
8. **同時保有銘柄数を増やす（1→2）** → ランク2位以下は精度低い
9. **RSI > 70 で除外する** → 取引機会減少、総損益悪化（2026-01実験）
10. **連続シグナルを除外する** → 勝率・PFは改善するが取引機会が半減し総損益悪化（2026-01実験）

### ベストプラクティス
- 変更は1つずつ行い、効果を検証する
- 取引回数が20回以上になるよう調整
- ボラティリティ条件は設けない

---

## 12. 今後の検討事項

### 試す価値があること
1. **利確/損切りターゲットを下げる（10% → 7%）**
   - 利確到達率が上がる可能性

2. **異なる評価期間でのテスト**
   - 2024年以外の期間でロバスト性確認

3. **別のモデル**
   - XGBoost、CatBoost、アンサンブル

### 試して失敗したこと（やらなくていい）
- スコア閾値の変更（上げても下げてもダメ）
- ボラティリティ条件
- トレンド系特徴量追加
- 同時保有銘柄数増加
- RSI > 70 除外（2026-01実験: 損益 -¥689,250）
- ボラ >= 3% フィルタ（2026-01実験: 損益 -¥373,219）
- 連続シグナル除外（2026-01実験: 損益 -¥685,767、ただしPF 1.44→1.84に改善）
- **Permutation Importanceによる特徴量選択**（2026-01実験）
  - 検証時は改善（勝率50.9%→57.0%、損益+154%）したが本番で大幅悪化
  - 原因: サンプリングに依存し不安定（検証と本番で選択特徴量が5個異なった）
  - セクター特徴量が過剰選択され、重要なfeat_sector_technologyが除外された
  - Gain-basedの方が再現性が高く安定
